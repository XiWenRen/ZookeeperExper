# 简介

`Zookeeper`最早是Apache Hadoop的一个子项目，用于在分布式系统中协作多个任务。现在已经是Apache软件基金会的一个顶级项目，包括Apache HBase,Kafka,Solr,Facebook Message等主流应用都在使用zookeeper来维护分布式场景下的数据一致性，利用zookeeper提供的简单API，我们就可以实现分布式环境下的诸如群首选举，竞争锁，命名服务，配置同步等强大且稳定的功能。

#### 1.Master\/Slave

整个zk集群分为两种角色，即`Master`和`Slave`,在zk中称为`Leader`和`Follower`,还有一种特殊的`Slave`称为`Observer`,功能和`Follower`相同，只是地位更低，不能参与`Leader`的选举。
`Leader`是整个zookeeper集群工作机制的核心，主要工作有两个 ：

> 事务请求的唯一调度者和处理者，保证集群中事务处理顺序
> 集群内部各服务器的调度者

Follower是zookeeper集群状态的跟随者，主要工作有

> 处理客户端非事务请求，转发事务请求给leader服务器。
> 参与事务请求 proposal的投票
> 参与leader选举投票

#### 2.工作模式

##### 2.1 恢复模式

zk集群启动后，或者Leader崩溃后，或者`Leader`失去大多数`Follower`响应，就会进入恢复模式，重新选举一个leader，系统默认的选举算法为fast paxos，算法的问题后续研究，只需要知道这是zk服务健壮和支持快速失败的核心，也是zk能够成为最流行的数据一致性框架的保证

##### 2.2 同步模式

选完`Leader`后就进入正常工作模式，在这个模式下Leader会将所有维护的状态同步到连接的`Follower`服务器上，保证整个zk集群的一致性，即所有的客户端不论连接的是哪个zk服务器，获取到的当前状态肯定是相同的。
使用zk的这两个特性，可以实现后续我们讨论的一些分布式环境下的应用场景，zk并不是为了解决这些问题而生的，但是zk的这些特性为解决这些问题提供了可靠的支持。

#### 3. znode

为了实现分布式数据管理和系统协调，zk使用数据节点来保存分布式环境中的各种信息，这些节点就被称为`znode`，这些节点会表现为一个具有层级关系的树状结构，类似于标准文件系统，区别在于每一个`znode`可以保存少量数据，默认情况下&lt;1M。
![一个简单主从模式的数据结构示例](/assets/QQ20151014-1@2x.png)
客户端可以通过create myNode "this is my node"的方式创建一个节点。
myNode是这个`znode`的名称，类似一个文件名，后面引号里的内容就是`znode`可以携带的数据。
创建节点时，还可以指定节点的类型：持久\(PERSISTENT\)型或者临时\(EPHEMERAL\)型节点。
持久型节点在创建之后只能通过客户端的`delete`命令删除，而临时节点除了可以被`delete`删除之外，客户端崩溃或关闭与服务端的连接时，都会消失。
在这两种类型之外，还可以额外指定节点为有序(SEQUENTIAL)的。此时创建的节点会在节点名称后添加唯一一个单调递增的整数，通过这个特性的可以很方便的实现创建唯一名称的节点。
至此，`znode`一共有四种类型，即持久，临时，持久有序和临时有序。
#### 4. watcher
zk的日常工作是基于发布/订阅模式的，客户端向自己的关心的`znode`注册一个监视点，即`watcher`。但是和常见的观察者模式不同的是，这里的`watcher`是单次触发的，客户端必须在每次收到通知后重新设置一个`watcher`。这是因为在数据变更非常频繁而且监听的客户端数量庞大的分布式环境中，保持一个永久的`Observer`非常消耗资源。因此，假设`client1`向`node1(version=0)`注册了一个`watcher1`，此时，`client2`对`node1`进行了两次连续的更新(version=1,version=2)，服务端通知到了`client1`的`watcher1`，随后`client1`对`node1`设置`watcher2`，此时并没有触发第二次watch，但是`client1`维护的`node1`的数据其实是`version2`，说明zk并不保证客户端能接受到每次更新的通知，但是保障客户端每次和服务器的通信都能获取到最新的数据。
#### 3. 典型应用场景

3.1 统一命名服务`Name Service`
分布式应用中，通常需要有一套完整的命名规则，既能够产生唯一的名称又便于人识别和记住，你可能只需要一个不会重复名称，就像数据库中产生一个唯一的数字主键一样。
`Name Service` 已经是zk内置的功能，你只要调用zk API就能实现

3.2 配置管理\(服务器之间配置文件同步\)
配置的管理在分布式应用环境中很常见，例如同一个应用系统需要多台 PC Server 运行，但是它们运行的应用系统的某些配置项是相同的，如果要修改这些相同的配置项，那么就必须同时修改每台运行这个应用系统的 PC Server，这样非常麻烦而且容易出错。
像这样的配置信息完全可以交给zk来管理，将配置信息保存在zk的某个目录节点中，然后将所有需要修改的应用机器监控配置信息的状态，一旦配置信息发生变化，每台应用机器就会收到zk的通知，然后从zk获取新的配置信息应用到系统中。
3.3 集群管理
3.4 分布式锁
3.5 队列管理

